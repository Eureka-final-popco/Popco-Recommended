name: Fast Python CI

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ë³€ê²½ì‚¬í•­ ê°ì§€ë¥¼ ìœ„í•´ ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # requirements.txt ë³€ê²½ ê°ì§€
    - name: Check if dependencies changed
      id: deps-changed
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
        fi
        
        if git diff --name-only $BASE_SHA $HEAD_SHA | grep -E "(requirements\.txt|setup\.py|pyproject\.toml)" || [ ! -d "venv" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ¨ Dependencies changed or venv missing - will reinstall"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "âš¡ Dependencies unchanged - using cache"
        fi
    
    # ì „ì—­ ê°€ìƒí™˜ê²½ ìºì‹œ (ëª¨ë“  ë¸Œëžœì¹˜ ê³µìœ )
    - name: Cache virtual environment
      if: steps.deps-changed.outputs.changed == 'false'
      uses: actions/cache@v3
      with:
        path: venv
        key: ${{ runner.os }}-venv-global-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-venv-global-
          ${{ runner.os }}-venv-
    
    # ì „ì—­ pip ìºì‹œ (ëª¨ë“  ë¸Œëžœì¹˜ ê³µìœ )
    - name: Cache pip dependencies
      if: steps.deps-changed.outputs.changed == 'true'
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-global-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-global-
          ${{ runner.os }}-pip-
    
    # ì˜ì¡´ì„± ì„¤ì¹˜ (ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ)
    - name: Install dependencies
      if: steps.deps-changed.outputs.changed == 'true'
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        echo "ðŸ“¦ Dependencies installed"
    
    # ì˜ì¡´ì„± ìŠ¤í‚µ ë©”ì‹œì§€
    - name: Skip dependency installation
      if: steps.deps-changed.outputs.changed == 'false'
      run: echo "âš¡ Using cached dependencies - skipping installation"
    
    # pytest ìºì‹œ
    - name: Cache pytest
      uses: actions/cache@v3
      with:
        path: .pytest_cache
        key: ${{ runner.os }}-pytest-${{ hashFiles('**/*.py') }}
        restore-keys: |
          ${{ runner.os }}-pytest-
    
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (í•­ìƒ ì‹¤í–‰)
    - name: Test with pytest
      run: |
        source venv/bin/activate
        PYTHONPATH=./app pytest -v --tb=short
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USERNAME: test
        DB_PASSWORD: test
        DB_NAME: test_db
        ENVIRONMENT: test
        AWS_S3_BUCKET_NAME: test-bucket
        AWS_S3_REGION: ap-northeast-2
        AWS_ACCESS_KEY_ID: dummy-key
        AWS_SECRET_ACCESS_KEY: dummy-secret
    
    # ê²°ê³¼ ìš”ì•½
    - name: Test Summary
      if: always()
      run: |
        echo "## Test Results ðŸ§ª" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.deps-changed.outputs.changed }}" == "true" ]; then
          echo "- **Dependencies**: âœ¨ Reinstalled (changed)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Dependencies**: âš¡ Cached (unchanged)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Tests**: ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
