name: Docker Build and Verify

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  build-and-verify:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # ë³€ê²½ì‚¬í•­ ê°ì§€ë¥¼ ìœ„í•´ ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # requirements.txt ë³€ê²½ ê°ì§€ (Docker ë¹Œë“œ ìºì‹œ í™œìš©ì„ ìœ„í•¨)
    - name: Check if dependencies changed
      id: deps-changed
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
        fi

        if git diff --name-only $BASE_SHA $HEAD_SHA | grep -E "(requirements\.txt|Dockerfile)" || [ ! -f "Dockerfile" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ¨ Dependencies or Dockerfile changed - will rebuild Docker image"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "âš¡ Dependencies and Dockerfile unchanged - using Docker cache"
        fi

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false # Docker Hubì— í‘¸ì‹œí•˜ì§€ ì•ŠìŒ
        tags: popco-recommended:latest
        cache-from: type=gha,scope=build-and-verify # GitHub Actions ìºì‹œ ì‚¬ìš©
        cache-to: type=gha,mode=max,scope=build-and-verify # GitHub Actions ìºì‹œ ì €ìž¥
        load: true # ë¡œì»¬ Docker ë°ëª¬ì— ì´ë¯¸ì§€ ë¡œë“œ (í…ŒìŠ¤íŠ¸ìš©)

    - name: Run Docker image smoke test
      run: |
        echo "ðŸ³ Running Docker smoke test..."
        
        # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
        docker run --rm -d -p 8000:8000 \
          --name popco-test \
          -e DB_HOST=localhost \
          -e DB_PORT=5432 \
          -e DB_USERNAME=test \
          -e DB_PASSWORD=test \
          -e DB_NAME=test_db \
          popco-recommended:latest
        
        # ì»¨í…Œì´ë„ˆ ì‹œìž‘ ëŒ€ê¸°
        echo "â³ Waiting for container to start..."
        sleep 15
        
        # Uvicorn ì‹œìž‘ í™•ì¸
        if docker logs popco-test 2>&1 | grep -E "(Uvicorn running|Application startup complete)"; then
          echo "âœ… Docker image started successfully and application is running."
        else
          echo "âŒ Docker image failed to start properly."
          echo "ðŸ“‹ Container logs:"
          docker logs popco-test
          docker stop popco-test
          exit 1
        fi
        
        # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
        echo "ðŸ§ª Testing API endpoints..."
        if curl -f http://localhost:8000/health 2>/dev/null; then
          echo "âœ… Health endpoint is responding"
        else
          echo "âš ï¸ Health endpoint test skipped or failed"
        fi
        
        # ì»¨í…Œì´ë„ˆ ì •ë¦¬
        docker stop popco-test
        echo "âœ… Smoke test completed successfully"

    - name: Test Summary
      if: always()
      run: |
        echo "## Docker Build & Verify Results ðŸ³" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.deps-changed.outputs.changed }}" == "true" ]; then
          echo "- **Dependencies/Dockerfile**: âœ¨ Changed - Docker image rebuilt" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Dependencies/Dockerfile**: âš¡ Unchanged - Docker cache used" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Docker Build**: ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Smoke Test**: ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY