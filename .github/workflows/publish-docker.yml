name: Docker Build and Verify

on:
  push:
    branches: [ "dev", "main" ]
  pull_request:
    branches: [ "dev", "main" ]

jobs:
  build-and-verify:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # ë³€ê²½ì‚¬í•­ ê°ì§€ë¥¼ ìœ„í•´ ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # requirements.txt ë³€ê²½ ê°ì§€ (Docker ë¹Œë“œ ìºì‹œ í™œìš©ì„ ìœ„í•¨)
    - name: Check if dependencies changed
      id: deps-changed
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
        fi

        if git diff --name-only $BASE_SHA $HEAD_SHA | grep -E "(requirements\.txt|Dockerfile)" || [ ! -f "Dockerfile" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ¨ Dependencies or Dockerfile changed - will rebuild Docker image"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "âš¡ Dependencies and Dockerfile unchanged - using Docker cache"
        fi

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false # Docker Hubì— í‘¸ì‹œí•˜ì§€ ì•ŠìŒ
        tags: popco-recommended:latest
        cache-from: type=gha,scope=build-and-verify # GitHub Actions ìºì‹œ ì‚¬ìš©
        cache-to: type=gha,mode=max,scope=build-and-verify # GitHub Actions ìºì‹œ ì €ìž¥
        load: true # ë¡œì»¬ Docker ë°ëª¬ì— ì´ë¯¸ì§€ ë¡œë“œ (í…ŒìŠ¤íŠ¸ìš©)

    - name: Verify Docker image
      run: |
        echo "ðŸ³ Verifying Docker image..."
        
        # ì´ë¯¸ì§€ ì¡´ìž¬ í™•ì¸
        if docker images popco-recommended:latest | grep -q popco-recommended; then
          echo "âœ… Docker image built successfully"
        else
          echo "âŒ Docker image not found"
          exit 1
        fi
        
        # ê°„ë‹¨í•œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (ì¦‰ì‹œ ì¢…ë£Œ)
        echo "ðŸ§ª Testing image can run..."
        docker run --rm \
          -e DB_HOST=localhost \
          -e DB_PORT=5432 \
          -e DB_USERNAME=test \
          -e DB_PASSWORD=test \
          -e DB_NAME=test_db \
          popco-recommended:latest \
          python -c "print('âœ… Image can execute Python successfully')"
        
        echo "âœ… Docker verification completed"

    - name: Test Summary
      if: always()
      run: |
        echo "## Docker Build & Verify Results ðŸ³" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.deps-changed.outputs.changed }}" == "true" ]; then
          echo "- **Dependencies/Dockerfile**: âœ¨ Changed - Docker image rebuilt" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Dependencies/Dockerfile**: âš¡ Unchanged - Docker cache used" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Docker Build**: ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Smoke Test**: ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
